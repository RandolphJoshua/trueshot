<section class="cart py-5 bg-light">
  <div class="container">
    <h2 class="fw-bold mb-4 text-center">Your Cart</h2>

    <div class="row g-4">
      <!-- LEFT: Items -->
      <div class="col-12 col-lg-8">

        <!-- Empty state -->
        <ng-template #emptyCart>
          <div class="card shadow-sm">
            <div class="card-body text-center py-5">
              <div class="display-6 mb-2">ðŸ‘œ</div>
              <h5 class="fw-semibold">Your cart is empty</h5>
              <p class="text-muted mb-4">Start exploring our catalog and add items to your bag.</p>
              <a class="btn btn-primary" routerLink="/catalog">Browse catalog</a>
            </div>
          </div>
        </ng-template>

        <div *ngIf="items.length; else emptyCart" class="vstack gap-3">
          <div class="card shadow-sm" *ngFor="let item of items">
            <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
              <!-- Thumb -->
              <div class="cart-thumb bg-light rounded overflow-hidden">
                <img
                  [src]="getProductImage(item.product?.id)"
                  (error)="onImgError($event)"
                  [alt]="(item.product.brand || 'Camera') + ' ' + (item.product.modelName || '')"
                  class="w-100 h-100 object-fit-cover"
                />
              </div>

              <!-- Info -->
              <div class="flex-grow-1">
                <h5 class="mb-1">
                  {{ item.product.brand }} {{ item.product.modelName }}
                </h5>
                <div class="small text-muted mb-2">
                  Condition:
                  <span class="badge rounded-pill bg-secondary">{{ item.product.conditionGrade || 'Unknown' }}</span>
                </div>

                <div class="d-flex align-items-center flex-wrap gap-3">
                  <div class="price fw-semibold">
                    {{ item.product.price | currency:'PHP':'symbol':'1.0-0' }}
                  </div>

                  <!-- Quantity controls -->
                  <div class="input-group input-group-sm qty-group" style="width: 120px;">
                    <button class="btn btn-outline-secondary" type="button" (click)="updateQuantity(item, -1)">âˆ’</button>
                    <span class="form-control text-center px-0">{{ item.quantity }}</span>
                    <button class="btn btn-outline-secondary" type="button" (click)="updateQuantity(item, 1)">+</button>
                  </div>

                  <!-- Line Subtotal -->
                  <div class="ms-auto fw-semibold">
                    {{ (item.product.price || 0) * item.quantity | currency:'PHP':'symbol':'1.0-0' }}
                  </div>
                </div>
              </div>

              <!-- Remove -->
              <div>
                <button type="button" class="btn btn-link text-danger p-0" (click)="remove(item)">
                  Remove
                </button>
              </div>
            </div>
          </div>

          <!-- Items subtotal row -->
          <div class="d-flex justify-content-end">
            <div class="text-end">
              <div class="small text-muted">Subtotal</div>
              <div class="fs-5 fw-bold">{{ total | currency:'PHP':'symbol':'1.0-0' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Summary + Checkout (sticky) -->
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm sticky-lg-top" style="top: 88px;">
          <div class="card-body p-4">
            <h5 class="fw-semibold mb-3">Order Summary</h5>

            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Items</span>
              <span>{{ items.length }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Subtotal</span>
              <span>{{ total | currency:'PHP':'symbol':'1.0-0' }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Shipping</span>
              <span>â€”</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold">Total</span>
              <span class="fs-5 fw-bold">{{ total | currency:'PHP':'symbol':'1.0-0' }}</span>
            </div>

            <!-- Checkout form -->
            <form #checkoutForm="ngForm" (ngSubmit)="checkout(checkoutForm)" novalidate>
              <div class="mb-3">
                <label class="form-label" for="buyerName">Full name</label>
                <input
                  id="buyerName"
                  name="buyerName"
                  type="text"
                  class="form-control"
                  required
                  minlength="2"
                  [(ngModel)]="buyer.name"
                  #buyerName="ngModel"
                  [class.is-invalid]="buyerName.invalid && buyerName.touched"
                />
                <div class="invalid-feedback">Name is required (min 2 characters).</div>
              </div>

              <div class="mb-3">
                <label class="form-label" for="buyerEmail">Email</label>
                <input
                  id="buyerEmail"
                  name="buyerEmail"
                  type="email"
                  class="form-control"
                  required
                  [(ngModel)]="buyer.email"
                  #buyerEmail="ngModel"
                  [class.is-invalid]="buyerEmail.invalid && buyerEmail.touched"
                />
                <div class="invalid-feedback">Please provide a valid email.</div>
              </div>

              <div class="mb-3">
                <label class="form-label" for="buyerPhone">Phone number</label>
                <input
                  id="buyerPhone"
                  name="buyerPhone"
                  type="tel"
                  class="form-control"
                  required
                  [(ngModel)]="buyer.phone"
                  #buyerPhone="ngModel"
                  [class.is-invalid]="buyerPhone.invalid && buyerPhone.touched"
                />
                <div class="invalid-feedback">Enter a valid phone number.</div>
              </div>

              <div class="mb-3">
                <label class="form-label" for="instructions">Special instructions (optional)</label>
                <textarea
                  id="instructions"
                  name="instructions"
                  rows="3"
                  class="form-control"
                  [(ngModel)]="buyer.instructions"
                  placeholder="Delivery notes, preferred contact time, etc."
                ></textarea>
              </div>

              <button class="btn btn-success w-100" type="submit" [disabled]="sending || !items.length">
                {{ sending ? 'Submittingâ€¦' : 'Submit order' }}
              </button>
            </form>

            <!-- Alerts -->
            <div *ngIf="successMessage" class="alert alert-success mt-3 mb-0">
              {{ successMessage }}
            </div>
            <div *ngIf="errorMessage" class="alert alert-danger mt-3 mb-0">
              {{ errorMessage }}
            </div>
          </div>
        </div>

        <!-- Continue shopping -->
        <div class="text-center mt-3">
          <a class="btn btn-outline-primary btn-sm" routerLink="/catalog">Continue shopping</a>
        </div>
      </div>
    </div>
  </div>
</section>
